<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>

<style>
:root{
 --bg:#05070c;--nav:#020617;--card:rgba(255,255,255,.08);
 --text:#fff;--accent:#1e90ff;--danger:#ff4d4d;--ok:#22c55e
}
body.light{
 --bg:#f4f6fb;--nav:#fff;--card:#fff;--text:#111827
}
*{box-sizing:border-box;font-family:Segoe UI,Tahoma}
body{margin:0;background:var(--bg);color:var(--text);transition:.3s}

/* NAV */
nav{
 display:flex;justify-content:space-between;align-items:center;
 padding:15px 20px;background:var(--nav)
}
nav button{
 margin-left:10px;background:var(--accent);
 border:none;color:#fff;padding:8px 14px;
 border-radius:10px;cursor:pointer
}

/* CONTAINER */
.container{max-width:1100px;margin:auto;padding:20px}

/* CARD */
.card{
 background:var(--card);padding:16px;border-radius:16px;
 margin-top:12px;display:flex;justify-content:space-between;
 align-items:center;transition:.3s
}
.card:hover{transform:translateY(-2px)}

.email{color:var(--accent);cursor:pointer}
.role{opacity:.7;font-size:14px}

.badge{
 background:var(--ok);
 color:white;
 padding:4px 10px;
 border-radius:999px;
 font-size:12px
}

.delete-btn{
 background:transparent;
 border:none;
 color:var(--danger);
 font-size:20px;
 cursor:pointer;
 transition:.2s
}
.delete-btn:hover{transform:scale(1.2)}

/* LOGS */
.logs{margin-top:30px}
.log{
 background:var(--card);
 padding:12px 14px;
 border-radius:12px;
 margin-top:10px;
 font-size:14px
}
.time{opacity:.6;font-size:12px}

/* MODALS */
.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.6);
 display:none;align-items:center;justify-content:center;
 z-index:10
}
.modal-box{
 background:var(--card);
 padding:25px;width:340px;border-radius:18px
}
.modal-box button{
 width:100%;margin-top:10px;padding:10px;
 border:none;border-radius:10px;cursor:pointer
}
.btn-danger{background:var(--danger);color:white}
.btn-cancel{background:#555;color:white}
</style>
</head>

<body>

<nav>
 <h3>ğŸ›  Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
 <div>
  <button onclick="toggleTheme()">ğŸŒ™ / â˜€ï¸</button>
  <button onclick="goCars()">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
  <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
 </div>
</nav>

<div class="container">

 <h2>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h2>
 <div id="users"></div>

 <div class="logs">
  <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h2>
  <div id="logs"></div>
 </div>

</div>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="modal" id="infoModal">
 <div class="modal-box">
  <h3>ğŸ“„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
  <p><b>Ø§Ù„Ø§Ø³Ù…:</b> <span id="mName"></span></p>
  <p><b>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</b> <span id="mEmail"></span></p>
  <p><b>Ø§Ù„Ø¯ÙˆØ±:</b> <span id="mRole"></span></p>
  <button class="btn-cancel" onclick="closeInfo()">Ø¥ØºÙ„Ø§Ù‚</button>
 </div>
</div>

<!-- Ø­Ø°Ù -->
<div class="modal" id="deleteModal">
 <div class="modal-box">
  <h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
  <p id="deleteText"></p>
  <button class="btn-danger" onclick="confirmDelete()">Ø­Ø°Ù</button>
  <button class="btn-cancel" onclick="closeDelete()">Ø¥Ù„ØºØ§Ø¡</button>
 </div>
</div>

<!-- SUPABASE -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ */
const SUPABASE_URL = "https://fquwikhishikbysnzqfd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_5MYNJ7ek_LaarRhPDBNODg_Yz-4qthG";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Ø­Ù…Ø§ÙŠØ© */
const session = JSON.parse(localStorage.getItem("session"));
if(!session || !session.role.startsWith("admin"))
 location.href="index.html";

/* Ø«ÙŠÙ… */
function toggleTheme(){
 document.body.classList.toggle("light");
 localStorage.setItem("theme",
  document.body.classList.contains("light")?"light":"dark");
}
if(localStorage.getItem("theme")==="light")
 document.body.classList.add("light");

/* Ø¹Ù†Ø§ØµØ± */
const box=document.getElementById("users");
const logBox=document.getElementById("logs");
let deleteId=null;

/* Ø³Ø¬Ù„ */
async function addLog(text){
 await supabase.from("logs").insert({text});
 renderLogs();
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
async function renderUsers(){
 const { data:users } = await supabase.from("users").select("*");
 box.innerHTML="";
 users.forEach(u=>{
  box.innerHTML+=`
   <div class="card">
    <div>
     <div class="email" onclick="showInfo(${u.id})">${u.email}</div>
     <div class="role">${u.role}</div>
    </div>
    ${
     u.role.startsWith("admin")
     ? `<span class="badge">ğŸ‘‘ Ø£Ø¯Ù…Ù†</span>`
     : `<button class="delete-btn" onclick="askDelete(${u.id},'${u.email}')">ğŸ—‘</button>`
    }
   </div>`;
 });
}

/* Ø§Ù„Ø³Ø¬Ù„ */
async function renderLogs(){
 const { data } = await supabase
  .from("logs")
  .select("*")
  .order("created_at",{ascending:false});

 logBox.innerHTML="";
 if(!data.length){
  logBox.innerHTML="<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª</p>";
  return;
 }
 data.forEach(l=>{
  logBox.innerHTML+=`
   <div class="log">${l.text}
    <div class="time">${new Date(l.created_at).toLocaleString("ar")}</div>
   </div>`;
 });
}

/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
async function showInfo(id){
 const { data:u } = await supabase.from("users").select("*").eq("id",id).single();
 mName.innerText=u.name;
 mEmail.innerText=u.email;
 mRole.innerText=u.role;
 infoModal.style.display="flex";
}
function closeInfo(){infoModal.style.display="none";}

/* Ø­Ø°Ù */
function askDelete(id,email){
 deleteId=id;
 deleteText.innerText=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${email}ØŸ`;
 deleteModal.style.display="flex";
}
function closeDelete(){
 deleteModal.style.display="none";
 deleteId=null;
}
async function confirmDelete(){
 await supabase.from("users").delete().eq("id",deleteId);
 addLog("ğŸ—‘ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…");
 closeDelete();
 renderUsers();
}

/* ØªÙ†Ù‚Ù„ */
function goCars(){
 addLog("ğŸš— Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª");
 location.href="admin-cars.html";
}
function logout(){
 localStorage.removeItem("session");
 location.href="index.html";
}

/* Ø¨Ø¯Ø¡ */
addLog("âœ… Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†");
renderUsers();
renderLogs();
</script>

</body>
</html>
