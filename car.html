<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</title>

<style>
:root{
 --bg1:#05070c;
 --bg2:#0b0f17;
 --blue:#1e90ff;
 --glass:rgba(255,255,255,.1);
 --border:rgba(255,255,255,.2);
}
*{box-sizing:border-box;font-family:Segoe UI,Tahoma}
body{
 margin:0;
 min-height:100vh;
 background:linear-gradient(180deg,var(--bg1),var(--bg2));
 color:white;
}
.container{
 max-width:900px;
 margin:auto;
 padding:20px;
}
.back{
 background:none;
 border:none;
 color:var(--blue);
 cursor:pointer;
 font-size:16px;
 margin-bottom:14px;
}
.card{
 background:var(--glass);
 backdrop-filter:blur(14px);
 border-radius:26px;
 padding:18px;
 border:1px solid var(--border);
}
.card img{
 width:100%;
 height:360px;
 object-fit:cover;
 border-radius:22px;
}
h2{margin:14px 0 6px}
.price{
 color:var(--blue);
 font-size:22px;
 font-weight:bold;
 margin-bottom:10px;
}
.desc{opacity:.9;line-height:1.7}
.stars span{
 font-size:30px;
 cursor:pointer;
 color:#555;
 transition:.2s;
}
.stars span.active,
.stars span:hover{color:gold}
.avg{margin-top:6px;color:#ccc}
.comment{
 background:rgba(255,255,255,.08);
 padding:12px;
 border-radius:14px;
 margin-top:10px;
 border:1px solid var(--border);
}
.comment small{color:#aaa}
input,textarea,button{
 width:100%;
 margin-top:12px;
 padding:12px;
 border-radius:14px;
 border:none;
 background:#0f1420;
 color:white;
}
textarea{resize:none;height:90px}
button.send{
 background:linear-gradient(135deg,#1e90ff,#3aa0ff);
 font-weight:600;
 cursor:pointer;
}
.empty{opacity:.6;text-align:center;margin-top:10px}
</style>
</head>

<body>

<div class="container">

<button class="back" onclick="goBack()">â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…Ø¹Ø±Ø¶</button>

<div class="card" id="card" style="display:none">
 <img id="img">
 <h2 id="name"></h2>
 <div class="price" id="price"></div>
 <div class="desc" id="desc"></div>

 <hr style="opacity:.2">

 <h3>â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h3>
 <div class="stars" id="stars"></div>
 <div class="avg" id="avg"></div>

 <hr style="opacity:.2">

 <h3>ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
 <input id="cname" placeholder="Ø§Ø³Ù…Ùƒ">
 <textarea id="ctext" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ"></textarea>
 <button class="send" onclick="addComment()">Ø¥Ø±Ø³Ø§Ù„</button>

 <div id="comments"></div>
</div>

</div>

<!-- SUPABASE -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ */
const SUPABASE_URL = "https://fquwikhishikbysnzqfd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_5MYNJ7ek_LaarRhPDBNODg_Yz-4qthG";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Ø­Ù…Ø§ÙŠØ© */
const session = JSON.parse(localStorage.getItem("session"));
if(!session){
 location.href="index.html";
}

/* Ø¬Ù„Ø¨ id Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· */
const params = new URLSearchParams(location.search);
const carId = params.get("id");
if(!carId){
 document.body.innerHTML="<h2 style='text-align:center;margin-top:80px'>ğŸš« Ø³ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h2>";
 throw "";
}

/* Ø¹Ù†Ø§ØµØ± */
const card=document.getElementById("card");
const img=document.getElementById("img");
const name=document.getElementById("name");
const price=document.getElementById("price");
const desc=document.getElementById("desc");
const stars=document.getElementById("stars");
const avg=document.getElementById("avg");
const commentsBox=document.getElementById("comments");

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© */
const { data:car } = await supabase
 .from("cars")
 .select("*")
 .eq("id",carId)
 .single();

if(!car){
 document.body.innerHTML="<h2 style='text-align:center;margin-top:80px'>ğŸš« Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h2>";
 throw "";
}

card.style.display="block";
img.src=car.img;
name.innerText=car.name;
price.innerText=car.price;
desc.innerText=car.desc;

/* â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
const { data:rates } = await supabase
 .from("ratings")
 .select("rate")
 .eq("car_id",carId);

let avgNum = rates?.length
 ? rates.reduce((a,b)=>a+b.rate,0)/rates.length
 : 0;

avg.innerText = rates?.length
 ? `Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${avgNum.toFixed(1)} â­`
 : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ… Ø¨Ø¹Ø¯";

for(let i=1;i<=5;i++){
 const s=document.createElement("span");
 s.innerText="â˜…";
 if(i<=Math.round(avgNum)) s.classList.add("active");
 s.onclick=async()=>{
  await supabase.from("ratings").insert({
   car_id:carId,
   rate:i
  });
  location.reload();
 };
 stars.appendChild(s);
}

/* ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
async function renderComments(){
 const { data:coms } = await supabase
  .from("comments")
  .select("*")
  .eq("car_id",carId)
  .order("created_at",{ascending:false});

 commentsBox.innerHTML="";
 if(!coms || !coms.length){
  commentsBox.innerHTML="<div class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>";
  return;
 }

 coms.forEach(c=>{
  commentsBox.innerHTML+=`
   <div class="comment">
    <b>${c.name}</b>
    <small> â€¢ ${new Date(c.created_at).toLocaleString("ar")}</small>
    <p>${c.text}</p>
   </div>`;
 });
}

/* Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ */
window.addComment = async function(){
 if(!cname.value.trim() || !ctext.value.trim()){
  alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
  return;
 }
 await supabase.from("comments").insert({
  car_id:carId,
  name:cname.value,
  text:ctext.value
 });
 cname.value="";
 ctext.value="";
 renderComments();
}

renderComments();

/* Ø±Ø¬ÙˆØ¹ */
function goBack(){
 location.href="index.html";
}
</script>

</body>
</html>
